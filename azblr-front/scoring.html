<!doctype html>
<html lang="ko">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="./bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="./bootstrap/css/cover.css">
    <link rel="shortcut icon" href="./img/favicon.ico">

    <title>AzeriteBlender: May the best traits win!</title>
  </head>
  <body>
    <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
      <header class="masthead mb-5">
        <div class="inner">
          <a class="navbar-brand" href="./"><h4 class="masthead-brand">AzrtBlndr</h4></a>
          <nav class="nav nav-masthead justify-content-center">
            <a class="nav-link" href="#" id="manual-button" data-toggle="modal" data-target="#manual-modal">사용법</a>
            <a class="d-none nav-link" href="./login.html" id="login-button">로그인</a>
            <a class="d-none nav-link" href="./register.html" id="register-button">회원가입</a>
            <a class="d-none nav-link" href="#" id="logout-button">로그아웃</a>
          </nav>
        </div>
      </header>
    
      <main role="main" class="inner cover">
        <p class="h2" id="p-csp-header"></p>
        <!-- add item form -->
        <div id="div-item-name" class="form-inline">
          <div id="div-input-item-name">
            <label class="sr-only" for="input-item-name">아이템 이름</label>
            <input type="text" class="form-control form-control-sm" id="input-item-name" placeholder="아이템 이름">
          </div>
          <div class="div-button-normal">
            <button type="button" class="btn btn-secondary btn-sm ml-1" id="add-button">추가</button>
          </div>
          <div class="div-button-loading d-none">
            <button type="button" class="btn btn-secondary btn-sm ml-1" disabled>
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div id="div-simc" class="d-none">
          <div id="div-simc-textarea">
            <textarea class="form-control form-control-sm col-md-10" id="textarea-simc" placeholder="Copy/Paste the text from the Simc addon (/simc Command)" rows=4></textarea>
          </div>
          <ul class="list-unstyled" id="div-simc-ul"></ul>
          <div id="div-simc-error" class="alert-text d-none">
              <small>장비 정보를 불러올 수 없습니다. /simc 문자열을 복사-붙여넣기 해주세요.</small>
          </div>
          <div class="div-button-normal">
            <button type="button" class="btn btn-secondary btn-sm mb-1 mt-1" id="add-simc-button">추가</button>
          </div>
          <div class="div-button-loading d-none">
            <button type="button" class="btn btn-secondary btn-sm mb-1 mt-1" disabled>
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="pl-4 form-group form-check">
          <input type="checkbox" class="form-check-input" id="checkbox-toggle-item-input">
          <label class="form-check-label" for="checkbox-toggle-item-input">Simc 애드온에서 불러오기</label>
        </div>

        <!-- added items -->
        <div class="jumbotron jumbotron-item p-4">
          <h5>머리</h5>
          <div id="item-1-none"><p><small>아직 등록된 장비가 없습니다.</small></p></div>
          <div id="item-1"></div>
          <hr class="my-4">
          <h5>어깨</h5>
          <div id="item-3-none"><p><small>아직 등록된 장비가 없습니다.</small></p></div>
          <div id="item-3"></div>
          <hr class="my-4">
          <h5>가슴</h5>
          <div id="item-5-none"><p><small>아직 등록된 장비가 없습니다.</small></p></div>
          <div id="item-5"></div>
        </div>
        <div class="pb-5">
          <div class="div-button-normal"><button type="button" class="btn btn-primary" id="blend-button">BLEND!</button></div>
          <div class="div-button-loading d-none"><button type="button" class="btn btn-primary" disabled><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span></button></div>
        </div>

        <!-- result -->
        <div id="result-area" class="d-none">
          <div id="carouselIndicators" class="carousel slide" data-ride="carousel" data-interval="false">
            <ol class="carousel-indicators">
              <li data-target="#carouselIndicators" data-slide-to="0" class="active"></li>
              <li data-target="#carouselIndicators" data-slide-to="1"></li>
              <li data-target="#carouselIndicators" data-slide-to="2"></li>
            </ol>
            <div class="carousel-inner">
              <div class="carousel-item active">
                <div class="jumbotron jumbotron-score p-4">
                  <h2 style="color: #5bc0de;"><b>단일 타겟 (patchwerk)</b></h2>
                  <div>updated : <span id="timestamp-1"></span></div>
                  <div id="div-result-1" class="div-result"></div>
                </div>
              </div>
              <div class="carousel-item">
                <div class="jumbotron jumbotron-score p-4">
                    <h2 style="color: #5bc0de;"><b>다중 타겟 (hecticaddcleave)</b></h2>
                  <div>updated : <span id="timestamp-2"></span></div>
                  <div id="div-result-2" class="div-result"></div>
                </div>
              </div>
              <div class="carousel-item">
                <div class="jumbotron jumbotron-score p-4">
                    <h2 style="color: #5bc0de;"><b>단일 타겟 + 다중 타겟</b></h2>
                  <div id="div-result-3" class="div-result"></div>
                </div>
              </div>
            </div>
            <a class="carousel-control-prev" href="#carouselIndicators" role="button" data-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#carouselIndicators" role="button" data-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="sr-only">Next</span>
            </a>
          </div>
        </div>
      </main>
    </div>

    <!-- Modal -->
    <div id="man-modal"></div>

    <!-- Optional JavaScript -->
    <script src="./js/jquery-3.3.1.min.js"></script>
    <script src="./bootstrap/js/bootstrap.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.7.2/js/solid.js" integrity="sha384-6FXzJ8R8IC4v/SKPI8oOcRrUkJU8uvFK6YJ4eDY11bJQz4lRw5/wGthflEOX8hjL" crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.7.2/js/fontawesome.js" integrity="sha384-xl26xwG2NVtJDw2/96Lmg09++ZjrXPc89j0j7JHjLOdSwHDHPHiucUjfllW0Ywrq" crossorigin="anonymous"></script>

    <!-- AZBLR JavaScript -->
    <script src="./apihost.js"></script>
    <script src="./js/navbar.js"></script>
    <script>
      var loadings = []
      function GetURLParameter(sParam) {
        var sPageURL = window.location.search.substring(1)
        var sPageURL = window.location.search.substring(1)
        var sURLVariables = sPageURL.split('&')

        for (var i = 0; i < sURLVariables.length; i++) {
          var sParameterName = sURLVariables[i].split('=')
          if (sParameterName[0] == sParam) {
            return sParameterName[1];
          }
        }
      }

      function setButtonsLoading() {
        if (!($('.div-button-normal').hasClass('d-none')) || $('.div-button-loading').hasClass('d-none')) {
          $('.div-button-normal').addClass('d-none')
          $('.div-button-loading').removeClass('d-none')
        }
        $('#textarea-simc').prop("disabled", true)
        $('#checkbox-toggle-item-input').prop('disabled', true)
        var _id = Math.floor(Math.random()*1000000+1)
        while(true) {
          if (!(_id in loadings)){
            loadings.push(_id)
            break
          }
          _id = Math.floor(Math.random()*1000000+1)
        }
        return _id
      }

      function setButtonsNormal(_id) {
        loadings = loadings.filter(i => i != _id)

        if (loadings.length == 0) {
          $('.div-button-loading').addClass('d-none')
          $('.div-button-normal').removeClass('d-none')
          $('#textarea-simc').prop("disabled", false)
          $('#checkbox-toggle-item-input').prop('disabled', false)
        }
      }

      function renderUserItems(items) {
        for (var i in items) {
          renderUserItem(items[i])
        }
      }

      function saveUserItems(tk, class_id, specialization_id) {
        var storage_key = "azblr-items-"+class_id+"-"+specialization_id
        var items = JSON.parse(sessionStorage.getItem(storage_key))
        var _headers = {}
        _headers['Authorization'] = tk
        var req_data = {
          'class_id': class_id,
          'specialization_id': specialization_id,
          'item_ids': items.map(i => i['id'])
        }
        var l_id = setButtonsLoading()
        $.ajax({
          url: API_HOST+'/api/user/class',
          type: 'post',
          headers: _headers,
          data: JSON.stringify(req_data),
          contentType: 'application/json',
          error: function(data) {
            alert(data.responseJSON.message)
          },
          complete: function() {
            setButtonsNormal(l_id)
          }
        })
      }

      function renderUserItem(item) {
        var slotTo = item['slotTo']
        var divSlot = $('#item-'+slotTo)
        var _i = $('<i/>', {
          class: 'fas fa-times'
        })
        var _a = $('<a/>', {
          class: 'btn btn-sm p-0 button-remove-item',
          href: '#',
          id: 'item-'+item['id']
        })
        var _img = $('<img/>', {
          class: "rounded",
          src: "https://wow.zamimg.com/images/wow/icons/small/"+item['icon']+'.jpg'
        })
        var _span = $('<span/>', {
          text: " "+item['name']+" "
        })
        var _p = $('<p/>', {
          class: "my-2"
        })

        _a.append(_i)
        _p.append(_img)
        _p.append(_span)
        _p.append(_a)
        divSlot.append(_p)
        
        _a.click(function() {
          // remove
          var itemId = $(this).attr('id').split('-')[1]
          var divSlot = $(this).parent().parent()
          $(this).parent().remove()
          if (divSlot.children().length == 0) {
            $('#item-'+slotTo+'-none').removeClass('d-none')
          }
          // sessionStorage
          var class_id = GetURLParameter('c_id')
          var specialization_id = GetURLParameter('sp_id')
          var storage_key = "azblr-items-"+class_id+"-"+specialization_id
          var items = JSON.parse(sessionStorage.getItem(storage_key)).filter(function(item) {
            return item.id != itemId
          })
          sessionStorage.setItem(storage_key, JSON.stringify(items))

          // put user class
          var tk = sessionStorage.getItem("azblr-tk")
          if (tk != null) {
            saveUserItems(tk, class_id, specialization_id)
          }

          $('#textarea-simc').trigger('input')
        })

        // remove defualt div
        var _none = $('#item-'+slotTo+'-none')
        if (!_none.hasClass('d-none')) _none.addClass('d-none')
      }

      function renderSimcItem(item, is_duplicate) {
        var footer = is_duplicate ? ' (이미 추가된 장비)' : ''
        var _li = $('<li/>', {
          class: 'mb-n1'
        })
        var _small = $('<small/>', {
          text: item['name'] + footer,
          class: is_duplicate ? 'strike-text' : 'ok-text'
        })

        _li.append(_small)
        $('#div-simc-ul').append(_li)
      }

      function renderSimcErrorItem(item_id) {
        var _li = $('<li/>', {
          class: 'mb-n1'
        })
        var _small = $('<small/>', {
          text: "Item ID:"+ item_id+" 는 해당 클래스의 아제라이트 장비가 아닙니다.",
          class: 'strike-text'
        })

        _li.append(_small)
        $('#div-simc-ul').append(_li)
      }

      function getItemInfoRenderStore(item_id, item_name, class_id, specialization_id, is_save) {
        var l_id = setButtonsLoading()
        if (item_id != null) {
          $.ajax({
            url: API_HOST+'/api/item/'+item_id+"/class/"+class_id,
            type: 'get',
            success: function(data) {
              renderUserItem(data)
              var storage_key = "azblr-items-"+class_id+"-"+specialization_id
              pushSessionStorageItem(storage_key, data)

              if (is_save) {
                var tk = sessionStorage.getItem("azblr-tk")
                if (tk != null) {
                  saveUserItems(tk, class_id, specialization_id)
                }
              }
            },
            error: function(data) {
              alert(data.responseJSON.message)
            },
            complete: function() {
              setButtonsNormal(l_id)
            }
          })
        } else if (item_name != null) {
          var req_data = {"item_name": item_name}
          $.ajax({
            url: API_HOST+'/api/item/class/'+class_id,
            type: 'post',
            data: JSON.stringify(req_data),
            contentType: 'application/json',
            success: function(data) {
              renderUserItem(data)
              var storage_key = "azblr-items-"+class_id+"-"+specialization_id
              pushSessionStorageItem(storage_key, data)

              if (is_save) {
                var tk = sessionStorage.getItem("azblr-tk")
                if (tk != null) {
                  saveUserItems(tk, class_id, specialization_id)
                }
              }
            },
            error: function(data) {
              alert(data.responseJSON.message)
            },
            complete: function() {
              setButtonsNormal(l_id)
            }
          })
        }
      }

      function getItemInfoSimcRenderStoreTemp(item_id, class_id, specialization_id) {
        var l_id = setButtonsLoading()

        var storage_key = "azblr-items-"+class_id+"-"+specialization_id
        var items = JSON.parse(sessionStorage.getItem(storage_key))
        var prev_items = JSON.parse(sessionStorage.getItem("azblr-items-simc-temp"))
        if (items != null && items.filter(i =>  i['id'] == item_id).length > 0) {
          var item = items.filter(i =>  i['id'] == item_id)[0]
          renderSimcItem(item, true)
          pushSessionStorageItem("azblr-items-simc", item)
          setButtonsNormal(l_id)
          return;
        } else if (prev_items != null && prev_items.filter(i =>  i['id'] == item_id).length > 0){
          var item = prev_items.filter(i =>  i['id'] == item_id)[0]
          renderSimcItem(item, false)
          pushSessionStorageItem("azblr-items-simc", item)
          setButtonsNormal(l_id)
          return;
        } else {
          $.ajax({
            url: API_HOST+'/api/item/'+item_id+"/class/"+class_id,
            type: 'get',
            success: function(data) {
              renderSimcItem(data, false)
              pushSessionStorageItem("azblr-items-simc", data)
            },
            error: function(data) {
              //alert(data.responseJSON.message)
              renderSimcErrorItem(item_id)
            },
            complete: function() {
              setButtonsNormal(l_id)
            }
          })
        }
      }

      function pushSessionStorageItem(storage_key, item) {
        var items_str = sessionStorage.getItem(storage_key)
        if (items_str == null) {
          sessionStorage.setItem(storage_key, JSON.stringify([item,]))
        } else {
          var items = JSON.parse(items_str)
          items.push(item)
          sessionStorage.setItem(storage_key, JSON.stringify(items))
        }
      }

      function getItemIdsFromSimcTextarea() {
        var l_id = setButtonsLoading()
        var items = []
        var text_lines = $('#textarea-simc').val().split('\n');
        for(var i=0; i < text_lines.length;i++) {
          var text = text_lines[i]
          if (text.includes("azerite_powers=")) {
            var s = text.split(',')
            for(var j=0; j<s.length;j++) {
              var v = s[j].split('=')
              if (v[0] == 'id') {
                items.push(v[1])
              }
            }
          }
        }
        setButtonsNormal(l_id)
        return items;
      }

      $(document).ready(function() {
        var class_id = GetURLParameter('c_id')
        var sp_id = GetURLParameter('sp_id')
        var class_sp_name = decodeURIComponent(GetURLParameter('csp_name'))
        var class_color = decodeURIComponent(GetURLParameter('c_color'))

        var storage_key = "azblr-items-"+class_id+"-"+sp_id

        $('#p-csp-header').text(class_sp_name)
        $('#p-csp-header').css("color", class_color)

        // init
        var tk = sessionStorage.getItem("azblr-tk")
        var _headers = {}
        _headers['Authorization'] = tk
        var items = sessionStorage.getItem(storage_key)
        if (items != null) {
          renderUserItems(JSON.parse(items))
        } else if (tk != null) {
          var l_id = setButtonsLoading()
          $.ajax({
            url: API_HOST+'/api/user/class/'+class_id+"/specialization/"+sp_id,
            type: 'get',
            headers: _headers,
            success:function(data) {
              if (data != null) {
                for (var i in data['item_ids']) {
                  getItemInfoRenderStore(data['item_ids'][i], null, class_id, sp_id, false)
                }
              }
            },
            error:function(data) {
              alert(data.responseJSON.message)
            },
            complete: function() {
              setButtonsNormal(l_id)
            }
          })  
        }

        // checkbox
        $('#checkbox-toggle-item-input').click(function() {
          $('#input-item-name').val('')
          $('#textarea-simc').val('')
          sessionStorage.removeItem("azblr-items-simc")
          $('#div-simc-ul').empty()
          $('#div-item-name').toggleClass("d-none")
          $('#div-simc').toggleClass("d-none")
        })

        // simc parsing
        $('#textarea-simc').on('input', function() {
          $('#div-simc-error').addClass('d-none')
          $('#div-simc-ul').empty()
          sessionStorage.setItem("azblr-items-simc-temp", sessionStorage.getItem("azblr-items-simc"))
          sessionStorage.removeItem("azblr-items-simc")

          var item_ids = getItemIdsFromSimcTextarea();
          for (var i=0; i<item_ids.length;i++) {
            var item_id = item_ids[i]
            getItemInfoSimcRenderStoreTemp(item_id, class_id, sp_id)
          }

          if ($('#textarea-simc').val() != '' && item_ids.length == 0) {
            $('#div-simc-error').removeClass('d-none')
          }

          sessionStorage.removeItem("azblr-items-simc-temp")
        })

        // add item
        $('#add-button').click(function() {
          // check duplicate item
          var item_name = $('#input-item-name').val()
          var class_id = GetURLParameter('c_id')
          var specialization_id = GetURLParameter('sp_id')
          var storage_key = "azblr-items-"+class_id+"-"+specialization_id
          var items = JSON.parse(sessionStorage.getItem(storage_key))
          if (items != null && items.filter(i =>  i['name'] == item_name).length > 0) {
            alert("이미 추가된 장비입니다")
            return
          }

          // append
          if (item_name == '') {
            return
          } else {
            getItemInfoRenderStore(null, item_name, class_id, specialization_id, true)
          }
          
          $('#input-item-name').val('')
        })

        // add item from simc
        $('#add-simc-button').click(function() {
          var class_id = GetURLParameter('c_id')
          var specialization_id = GetURLParameter('sp_id')
          var storage_key = "azblr-items-"+class_id+"-"+specialization_id
          var stored_items = JSON.parse(sessionStorage.getItem(storage_key))
          var simc_items = JSON.parse(sessionStorage.getItem("azblr-items-simc"))

          if (simc_items != null && simc_items.length > 0) {
            var count = 0
            for (var i=0;i<simc_items.length;i++) {
              var item = simc_items[i]
              if (stored_items == null || stored_items.filter(i =>  i['id'] == item['id']).length == 0) {
                renderUserItem(item)
                var storage_key = "azblr-items-"+class_id+"-"+specialization_id
                pushSessionStorageItem(storage_key, item)
                count = count+1
              }
            }
            if (count > 0) {
              var tk = sessionStorage.getItem("azblr-tk")
              if (tk != null) {
                saveUserItems(tk, class_id, specialization_id)
              }
              $('#textarea-simc').trigger('input')
            }
          }
        })

        // blend
        $('#blend-button').click(function() {
          var class_id = GetURLParameter('c_id')
          var specialization_id = GetURLParameter('sp_id')
          var storage_key = "azblr-items-"+class_id+"-"+specialization_id
          var items = JSON.parse(sessionStorage.getItem(storage_key))
          var req_data = {
            'class_id': class_id,
            'specialization_id': specialization_id,
            'items': items
          }

          var l_id = setButtonsLoading()
          if (!$('#result-area').hasClass('d-none'))
            $('#result-area').addClass('d-none')
          $.ajax({
            url: API_HOST+'/api/score',
            type: 'post',
            data: JSON.stringify(req_data),
            contentType: 'application/json',
            success: function(data) {
              $('.div-result').empty();

              for (var i in data['timestamps']) {
                $('#timestamp-'+i).text(data['timestamps'][i])
              }
              for (var i in data['score_order']) {
                for (var j in data['score_order'][i]) {
                  var comb = data['score_order'][i][j]

                  var _div = $('<div/>', {
                    class: "py-2"
                  })
                  var _h = $('<h5/>', {
                    text: "- "+(parseInt(j)+1)+" -",
                    css: {
                      color: 'gold'
                    }
                  })
                  _div.append(_h)
                  for (k in comb['items']) {
                    var item = comb['items'][k]

                    var _p = $('<p/>', {
                      class: "my-3"
                    })
                    var _img = $('<img/>', {
                      class: "rounded",
                      src: "https://wow.zamimg.com/images/wow/icons/small/"+item['icon']+'.jpg'
                    })
                    var _span_item = $('<span/>', {
                      text: " "+item['name']+" "
                    })
                    var _br = $('<br/>')
                    var _span_spell = $('<span/>', {
                      text: '>> '+item['selectedPower'].map(v => v['spellName']+v['subSpellName']).join(' / ')
                    })
                    _p.append(_img)
                    _p.append(_span_item)
                    _p.append(_br)
                    _p.append(_span_spell)
                    _div.append(_p)
                  }
                  var _span_score = $('<span/>', {
                    text: '점수: '+comb['score'][i],
                    css: {
                      color: '#0275d8'
                    }
                  })
                  _div.append(_span_score)
                  _div.appendTo($('#div-result-'+i))
                }
              }
              $('#result-area').removeClass('d-none')
            },
            complete: function() {
              setButtonsNormal(l_id)
            }
          })
        })
      })
    </script>
  </body>
</html>