<!doctype html>
<html lang="ko">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="./bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="./bootstrap/css/cover.css">
    <link rel="shortcut icon" href="./img/favicon.ico">

    <title>AzeriteBlender: May the best traits win!</title>
  </head>
  <body>
    <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
      <header class="masthead mb-5">
        <div class="inner">
          <a class="navbar-brand" href="./"><h4 class="masthead-brand">AzrtBlndr</h4></a>
          <nav class="nav nav-masthead justify-content-center">
            <a class="nav-link" href="#" id="manual-button" data-toggle="modal" data-target="#manual-modal">사용법</a>
            <a class="d-none nav-link" href="./login.html" id="login-button">로그인</a>
            <a class="d-none nav-link" href="./register.html" id="register-button">회원가입</a>
            <a class="d-none nav-link" href="#" id="logout-button">로그아웃</a>
          </nav>
        </div>
      </header>
    
      <main role="main" class="inner cover">
        <p class="h2" id="p-csp-header"></p>
        <!-- add item form -->
        <div class="form-inline pb-4">
          <div id="div-input-item-name">
            <label class="sr-only" for="input-item-id">아이템 ID</label>
            <input type="text" class="form-control form-control-sm" id="input-item-id" placeholder="아이템 ID">
          </div>
          <div id="div-input-item-id" class="d-none">
            <label class="sr-only" for="input-item-name">아이템 이름</label>
            <input type="text" class="form-control form-control-sm" id="input-item-name" placeholder="아이템 이름">
          </div>
          <div class="div-button-normal">
            <button type="button" class="btn btn-secondary btn-sm ml-1" id="add-button">추가</button>
          </div>
          <div class="div-button-loading d-none">
            <button type="button" class="btn btn-secondary btn-sm ml-1" disabled>
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            </button>
          </div>
          <div class="pl-2 form-group form-check">
            <input type="checkbox" class="form-check-input" id="checkbox-toggle-item-input">
            <label class="form-check-label" for="checkbox-toggle-item-input">이름으로 검색</label>
          </div>
        </div>

        <!-- added items -->
        <div class="jumbotron jumbotron-item p-4">
          <h5>머리</h5>
          <div id="item-1-none"><p><small>아직 등록된 장비가 없습니다.</small></p></div>
          <div id="item-1"></div>
          <hr class="my-4">
          <h5>어깨</h5>
          <div id="item-3-none"><p><small>아직 등록된 장비가 없습니다.</small></p></div>
          <div id="item-3"></div>
          <hr class="my-4">
          <h5>가슴</h5>
          <div id="item-5-none"><p><small>아직 등록된 장비가 없습니다.</small></p></div>
          <div id="item-5"></div>
        </div>
        <div class="pb-5">
          <div class="div-button-normal"><button type="button" class="btn btn-primary" id="blend-button">BLEND!</button></div>
          <div class="div-button-loading d-none"><button type="button" class="btn btn-primary" disabled><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span></button></div>
        </div>

        <!-- result -->
        <div id="result-area" class="d-none">
          <div id="carouselIndicators" class="carousel slide" data-ride="carousel" data-interval="false">
            <ol class="carousel-indicators">
              <li data-target="#carouselIndicators" data-slide-to="0" class="active"></li>
              <li data-target="#carouselIndicators" data-slide-to="1"></li>
              <li data-target="#carouselIndicators" data-slide-to="2"></li>
            </ol>
            <div class="carousel-inner">
              <div class="carousel-item active">
                <div class="jumbotron jumbotron-score p-4">
                  <h2 style="color: #5bc0de;"><b>단일 타겟 (patchwerk)</b></h2>
                  <div>updated : <span id="timestamp-1"></span></div>
                  <div id="div-result-1" class="div-result"></div>
                </div>
              </div>
              <div class="carousel-item">
                <div class="jumbotron jumbotron-score p-4">
                    <h2 style="color: #5bc0de;"><b>다중 타겟 (hecticaddcleave)</b></h2>
                  <div>updated : <span id="timestamp-2"></span></div>
                  <div id="div-result-2" class="div-result"></div>
                </div>
              </div>
              <div class="carousel-item">
                <div class="jumbotron jumbotron-score p-4">
                    <h2 style="color: #5bc0de;"><b>단일 타겟 + 다중 타겟</b></h2>
                  <div id="div-result-3" class="div-result"></div>
                </div>
              </div>
            </div>
            <a class="carousel-control-prev" href="#carouselIndicators" role="button" data-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#carouselIndicators" role="button" data-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="sr-only">Next</span>
            </a>
          </div>
        </div>
      </main>
    </div>

    <!-- Modal -->
    <div id="man-modal"></div>

    <!-- Optional JavaScript -->
    <script src="./js/jquery-3.3.1.min.js"></script>
    <script src="./bootstrap/js/bootstrap.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.7.2/js/solid.js" integrity="sha384-6FXzJ8R8IC4v/SKPI8oOcRrUkJU8uvFK6YJ4eDY11bJQz4lRw5/wGthflEOX8hjL" crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.7.2/js/fontawesome.js" integrity="sha384-xl26xwG2NVtJDw2/96Lmg09++ZjrXPc89j0j7JHjLOdSwHDHPHiucUjfllW0Ywrq" crossorigin="anonymous"></script>

    <!-- AZBLR JavaScript -->
    <script src="./apihost.js"></script>
    <script src="./js/navbar.js"></script>
    <script>
      var loadings = []
      function GetURLParameter(sParam) {
        var sPageURL = window.location.search.substring(1)
        var sPageURL = window.location.search.substring(1)
        var sURLVariables = sPageURL.split('&')

        for (var i = 0; i < sURLVariables.length; i++) {
          var sParameterName = sURLVariables[i].split('=')
          if (sParameterName[0] == sParam) {
            return sParameterName[1];
          }
        }
      }

      function setButtonsLoading() {
        if (!($('.div-button-normal').hasClass('d-none')) || $('.div-button-loading').hasClass('d-none')) {
          $('.div-button-normal').addClass('d-none')
          $('.div-button-loading').removeClass('d-none')
        }
        var _id = Math.floor(Math.random()*1000000+1)
        while(true) {
          if (!(_id in loadings)){
            loadings.push(_id)
            break
          }
          _id = Math.floor(Math.random()*1000000+1)
        }
        return _id
      }

      function setButtonsNormal(_id) {
        loadings = loadings.filter(i => i != _id)

        if (loadings.length == 0) {
          $('.div-button-loading').addClass('d-none')
          $('.div-button-normal').removeClass('d-none')
        }
      }

      function renderUserItems(items) {
        for (var i in items) {
          renderUserItem(items[i])
        }
      }

      function saveUserItems(tk, class_id, specialization_id) {
        var storage_key = "azblr-items-"+class_id+"-"+specialization_id
        var items = JSON.parse(sessionStorage.getItem(storage_key))
        var _headers = {}
        _headers['Authorization'] = tk
        var req_data = {
          'class_id': class_id,
          'specialization_id': specialization_id,
          'item_ids': items.map(i => i['id'])
        }
        var l_id = setButtonsLoading()
        $.ajax({
          url: API_HOST+'/api/user/class',
          type: 'post',
          headers: _headers,
          data: JSON.stringify(req_data),
          contentType: 'application/json',
          error: function(data) {
            alert(data.responseJSON.message)
          },
          complete: function() {
            setButtonsNormal(l_id)
          }
        })
      }

      function renderUserItem(item) {
        var slotTo = item['slotTo']
        var divSlot = $('#item-'+slotTo)
        var _i = $('<i/>', {
          class: 'fas fa-times'
        })
        var _a = $('<a/>', {
          class: 'btn btn-sm p-0 button-remove-item',
          href: '#',
          id: 'item-'+item['id']
        })
        var _img = $('<img/>', {
          class: "rounded",
          src: "https://wow.zamimg.com/images/wow/icons/small/"+item['icon']+'.jpg'
        })
        var _span = $('<span/>', {
          text: " "+item['name']+" "
        })
        var _p = $('<p/>', {
          class: "my-2"
        })

        _a.append(_i)
        _p.append(_img)
        _p.append(_span)
        _p.append(_a)
        divSlot.append(_p)
        
        _a.click(function() {
          // remove
          var itemId = $(this).attr('id').split('-')[1]
          var divSlot = $(this).parent().parent()
          $(this).parent().remove()
          if (divSlot.children().length == 0) {
            $('#item-'+slotTo+'-none').removeClass('d-none')
          }
          // sessionStorage
          var class_id = GetURLParameter('c_id')
          var specialization_id = GetURLParameter('sp_id')
          var storage_key = "azblr-items-"+class_id+"-"+specialization_id
          var items = JSON.parse(sessionStorage.getItem(storage_key)).filter(function(item) {
            return item.id != itemId
          })
          sessionStorage.setItem(storage_key, JSON.stringify(items))

          // put user class
          var tk = sessionStorage.getItem("azblr-tk")
          if (tk != null) {
            saveUserItems(tk, class_id, specialization_id)
          }
        })

        // remove defualt div
        var _none = $('#item-'+slotTo+'-none')
        if (!_none.hasClass('d-none')) _none.addClass('d-none')
      }

      function getItemInfoRenderStore(item_id, item_name, class_id, specialization_id, is_save) {
        var l_id = setButtonsLoading()
        if (item_id != null) {
          $.ajax({
            url: API_HOST+'/api/item/'+item_id+"/class/"+class_id,
            type: 'get',
            success: function(data) {
              renderUserItem(data)
              var storage_key = "azblr-items-"+class_id+"-"+specialization_id
              var items_str = sessionStorage.getItem(storage_key)
              if (items_str == null) {
                sessionStorage.setItem(storage_key, JSON.stringify([data,]))
              } else {
                var items = JSON.parse(items_str)
                items.push(data)
                sessionStorage.setItem(storage_key, JSON.stringify(items))
              }

              if (is_save) {
                var tk = sessionStorage.getItem("azblr-tk")
                if (tk != null) {
                  saveUserItems(tk, class_id, specialization_id)
                }
              }
            },
            error: function(data) {
              alert(data.responseJSON.message)
            },
            complete: function() {
              setButtonsNormal(l_id)
            }
          })
        } else if (item_name != null) {
          var req_data = {"item_name": item_name}
          $.ajax({
            url: API_HOST+'/api/item/class/'+class_id,
            type: 'post',
            data: JSON.stringify(req_data),
            contentType: 'application/json',
            success: function(data) {
              renderUserItem(data)
              var storage_key = "azblr-items-"+class_id+"-"+specialization_id
              var items_str = sessionStorage.getItem(storage_key)
              if (items_str == null) {
                sessionStorage.setItem(storage_key, JSON.stringify([data,]))
              } else {
                var items = JSON.parse(items_str)
                items.push(data)
                sessionStorage.setItem(storage_key, JSON.stringify(items))
              }

              if (is_save) {
                var tk = sessionStorage.getItem("azblr-tk")
                if (tk != null) {
                  saveUserItems(tk, class_id, specialization_id)
                }
              }
            },
            error: function(data) {
              alert(data.responseJSON.message)
            },
            complete: function() {
              setButtonsNormal(l_id)
            }
          })
        }
      }

      $(document).ready(function() {
        var class_id = GetURLParameter('c_id')
        var sp_id = GetURLParameter('sp_id')
        var class_sp_name = decodeURIComponent(GetURLParameter('csp_name'))
        var class_color = decodeURIComponent(GetURLParameter('c_color'))

        var storage_key = "azblr-items-"+class_id+"-"+sp_id

        $('#p-csp-header').text(class_sp_name)
        $('#p-csp-header').css("color", class_color)

        // init
        $('#checkbox-toggle-item-input').click(function() {
          $('#input-item-id').val('')
          $('#input-item-name').val('')
          $('#div-input-item-name').toggleClass("d-none")
          $('#div-input-item-id').toggleClass("d-none")
        })

        var tk = sessionStorage.getItem("azblr-tk")
        var _headers = {}
        _headers['Authorization'] = tk
        var items = sessionStorage.getItem(storage_key)
        if (items != null) {
          renderUserItems(JSON.parse(items))
        } else if (tk != null) {
          var l_id = setButtonsLoading()
          $.ajax({
            url: API_HOST+'/api/user/class/'+class_id+"/specialization/"+sp_id,
            type: 'get',
            headers: _headers,
            success:function(data) {
              if (data != null) {
                for (var i in data['item_ids']) {
                  getItemInfoRenderStore(data['item_ids'][i], null, class_id, sp_id, false)
                }
              }
            },
            error:function(data) {
              alert(data.responseJSON.message)
            },
            complete: function() {
              setButtonsNormal(l_id)
            }
          })  
        }

        // add item
        $('#add-button').click(function() {
          // check duplicate item
          var item_id = $('#input-item-id').val()
          var item_name = $('#input-item-name').val()
          var class_id = GetURLParameter('c_id')
          var specialization_id = GetURLParameter('sp_id')
          var storage_key = "azblr-items-"+class_id+"-"+specialization_id
          var items = JSON.parse(sessionStorage.getItem(storage_key))
          if (items != null && items.filter(i =>  i['name'] == item_name).length > 0) {
            alert("이미 추가된 장비입니다")
            return
          }

          // append
          if (item_id == '' && item_name == '') {
            return
          } else if (item_id != '' && item_name == '') {
            getItemInfoRenderStore(item_id, null, class_id, specialization_id, true)
          } else if (item_id == '' && item_name != '') {
            getItemInfoRenderStore(null, item_name, class_id, specialization_id, true)
          } else {
            alert("something wrong.. please try again")
          }
          
          $('#input-item-id').val('')
          $('#input-item-name').val('')
        })

        // blend
        $('#blend-button').click(function() {
          var class_id = GetURLParameter('c_id')
          var specialization_id = GetURLParameter('sp_id')
          var storage_key = "azblr-items-"+class_id+"-"+specialization_id
          var items = JSON.parse(sessionStorage.getItem(storage_key))
          var req_data = {
            'class_id': class_id,
            'specialization_id': specialization_id,
            'items': items
          }

          var l_id = setButtonsLoading()
          if (!$('#result-area').hasClass('d-none'))
            $('#result-area').addClass('d-none')
          $.ajax({
            url: API_HOST+'/api/score',
            type: 'post',
            data: JSON.stringify(req_data),
            contentType: 'application/json',
            success: function(data) {
              $('.div-result').empty();

              for (var i in data['timestamps']) {
                $('#timestamp-'+i).text(data['timestamps'][i])
              }
              for (var i in data['score_order']) {
                for (var j in data['score_order'][i]) {
                  var comb = data['score_order'][i][j]

                  var _div = $('<div/>', {
                    class: "py-2"
                  })
                  var _h = $('<h5/>', {
                    text: "- "+(parseInt(j)+1)+" -",
                    css: {
                      color: 'gold'
                    }
                  })
                  _div.append(_h)
                  for (k in comb['items']) {
                    var item = comb['items'][k]

                    var _p = $('<p/>', {
                      class: "my-3"
                    })
                    var _img = $('<img/>', {
                      class: "rounded",
                      src: "https://wow.zamimg.com/images/wow/icons/small/"+item['icon']+'.jpg'
                    })
                    var _span_item = $('<span/>', {
                      text: " "+item['name']+" "
                    })
                    var _br = $('<br/>')
                    var _span_spell = $('<span/>', {
                      text: '>> '+item['selectedPower'].map(v => v['spellName']+v['subSpellName']).join(' / ')
                    })
                    _p.append(_img)
                    _p.append(_span_item)
                    _p.append(_br)
                    _p.append(_span_spell)
                    _div.append(_p)
                  }
                  var _span_score = $('<span/>', {
                    text: '점수: '+comb['score'][i],
                    css: {
                      color: '#0275d8'
                    }
                  })
                  _div.append(_span_score)
                  _div.appendTo($('#div-result-'+i))
                }
              }
              $('#result-area').removeClass('d-none')
            },
            complete: function() {
              setButtonsNormal(l_id)
            }
          })
        })
      })
    </script>
  </body>
</html>